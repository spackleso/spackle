name: CI

on: push

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Use Node.js 16
        uses: actions/setup-node@v3
        with:
          node-version: 16.x

      - name: Install redis
        run: |
          sudo apt-get update
          sudo apt-get install -y redis-tools redis-server

      - name: Verify that redis is up
        run: redis-cli ping

      - name: Install modules
        run: yarn

      - name: Set up Supabase
        uses: supabase/setup-cli@v1
        with:
          version: 1.60.1

      - run: supabase start

      - name: Run tests
        run: yarn test
        env:
          AWS_REGION: us-west-2
          BETTERSTACK_LOGS_TOKEN: super-secret-token
          DATABASE_URL: postgresql://postgres:postgres@localhost:54322/postgres
          REDIS_URL: redis://localhost:6379
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
          SUPABASE_URL: http://localhost:54321
          STRIPE_SIGNING_SECRET: ${{ secrets.STRIPE_SIGNING_SECRET }}
          STRIPE_LIVE_SECRET_KEY: ${{ secrets.STRIPE_LIVE_SECRET_KEY }}
          STRIPE_TEST_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}