name: Run unit tests
description: Runs all tests in the repository

runs:
  using: composite
  steps:
    - name: Install
      uses: ./.github/actions/install

    - name: Install redis
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y redis-tools redis-server

    - name: Verify that redis is up
      shell: bash
      run: redis-cli ping

    - name: Set up Supabase
      uses: supabase/setup-cli@v1
      with:
        version: 1.60.1

    - run: supabase start
      shell: bash

    - name: Run tests
      shell: bash
      run: pnpm turbo test
      env:
        AWS_REGION: us-west-2
        BETTERSTACK_LOGS_TOKEN: super-secret-token
        DATABASE_URL: postgresql://postgres:postgres@localhost:54322/postgres
        REDIS_URL: redis://localhost:6379
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        SUPABASE_JWT_SECRET: super-secret-jwt-token-with-at-least-32-characters-long
        SUPABASE_URL: http://localhost:54321
        STRIPE_SIGNING_SECRET: ${{ secrets.STRIPE_SIGNING_SECRET }}
        STRIPE_LIVE_SECRET_KEY: ${{ secrets.STRIPE_LIVE_SECRET_KEY }}
        STRIPE_TEST_SECRET_KEY: ${{ secrets.STRIPE_TEST_SECRET_KEY }}